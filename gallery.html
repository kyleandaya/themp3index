<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library - The MP3 Index</title>
    <!-- Fonts - will work offline with system fallbacks -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600;700&family=Shadows+Into+Light&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- System font fallbacks for offline use -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1 class="handwritten-title">library</h1>
            <p class="subtitle">The MP3 Index is a project to peek into others’ relationships with music and sound. “Nostalgia is a mixed emotion that is often evoked by music.”</p>
        </header>

        <main class="gallery-content">
            <div id="gallery" class="gallery-grid">
                <div class="empty-state" id="emptyState">
                    <p>no memories shared yet</p>
                    <p style="margin-top: 1rem; font-size: 1.2rem;">be the first to share yours</p>
                    <a href="index.html" class="btn-primary">share a memory</a>
                </div>
            </div>
        </main>

        <footer>
            <a href="index.html" class="gallery-link"><span class="material-icons">arrow_back</span> share your memory</a>
        </footer>
    </div>

    <script src="script.js"></script>
    <script>
        // Global audio preview element
        let previewAudio = null;
        let currentPreviewIndex = null;

        // Load and display gallery
        function loadGallery() {
            const memories = getMemories();
            const gallery = document.getElementById('gallery');
            const emptyState = document.getElementById('emptyState');

            if (memories.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            gallery.innerHTML = '';

            memories.forEach((memory, index) => {
                const card = document.createElement('div');
                card.className = 'gallery-card';
                card.dataset.memoryIndex = index;
                
                card.onclick = () => {
                    stopPreview();
                    window.location.href = `player.html?id=${index}`;
                };

                // Create a preview of the memory text
                const memoryPreview = memory.memory.length > 100 
                    ? memory.memory.substring(0, 100) + '...' 
                    : memory.memory;

                // Get label color (use stored or generate new)
                const labelColor = memory.labelColor || ['#e74c3c', '#f39c12', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6'][Math.floor(Math.random() * 6)];
                const recipientName = memory.recipientName || 'someone';

                // Create vinyl record SVG
                const vinylSVG = `
                    <svg class="vinyl-record" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                        <!-- Outer ring -->
                        <circle cx="100" cy="100" r="95" fill="#1a1a1a" stroke="#2a2a2a" stroke-width="2"/>
                        <!-- Grooves -->
                        <circle cx="100" cy="100" r="85" fill="none" stroke="#2a2a2a" stroke-width="0.5" opacity="0.5"/>
                        <circle cx="100" cy="100" r="75" fill="none" stroke="#2a2a2a" stroke-width="0.5" opacity="0.5"/>
                        <circle cx="100" cy="100" r="65" fill="none" stroke="#2a2a2a" stroke-width="0.5" opacity="0.5"/>
                        <circle cx="100" cy="100" r="55" fill="none" stroke="#2a2a2a" stroke-width="0.5" opacity="0.5"/>
                        <!-- Label -->
                        <circle cx="100" cy="100" r="35" fill="${labelColor}"/>
                        <circle cx="100" cy="100" r="30" fill="${labelColor}" opacity="0.8"/>
                        <!-- Center hole -->
                        <circle cx="100" cy="100" r="8" fill="#1a1a1a"/>
                    </svg>
                `;

                card.innerHTML = `
                    <div class="memory-card-content">
                        <div class="vinyl-container-default">
                            ${vinylSVG}
                        </div>
                        <div class="recipient-name-hover">for ${recipientName}</div>
                    </div>
                `;

                // Add hover event listeners for audio preview
                card.addEventListener('mouseenter', () => {
                    playPreview(memory, index, card);
                });

                card.addEventListener('mouseleave', () => {
                    stopPreview(card);
                });

                gallery.appendChild(card);
            });
        }

        let fadeInInterval = null;
        let fadeOutInterval = null;
        let previewTimeout = null;

        function playPreview(memory, index, card) {
            // Stop any currently playing preview
            stopPreview(null);

            // Check if memory has valid audio data
            if (!memory.audioData) {
                console.log('No audio data for this memory');
                return;
            }

            // Add spinning class to vinyl (find it in the default container)
            const vinylContainer = card.querySelector('.vinyl-container-default');
            const vinylRecord = vinylContainer ? vinylContainer.querySelector('.vinyl-record') : null;
            if (vinylRecord) {
                vinylRecord.classList.add('spinning');
            }

            // Create audio element if it doesn't exist
            if (!previewAudio) {
                previewAudio = new Audio();
                previewAudio.volume = 0; // Start at 0 for fade in
            } else {
                // Reset volume if audio already exists
                previewAudio.volume = 0;
            }

            // Set source and load
            previewAudio.src = memory.audioData;
            previewAudio.currentTime = 0;
            
            // Wait for audio to be ready
            previewAudio.addEventListener('loadeddata', () => {
                previewAudio.play().catch(e => {
                    console.log('Preview play failed:', e);
                    if (vinylRecord) {
                        vinylRecord.classList.remove('spinning');
                    }
                    if (fadeInInterval) {
                        clearInterval(fadeInInterval);
                        fadeInInterval = null;
                    }
                });
            }, { once: true });
            
            previewAudio.load();
            
            // Fade in
            fadeInInterval = setInterval(() => {
                if (previewAudio && previewAudio.volume < 0.4) {
                    previewAudio.volume = Math.min(previewAudio.volume + 0.05, 0.4);
                } else {
                    if (fadeInInterval) {
                        clearInterval(fadeInInterval);
                        fadeInInterval = null;
                    }
                }
            }, 50);

            // Stop after 3 seconds with fade out
            previewTimeout = setTimeout(() => {
                if (previewAudio && previewAudio.currentTime < 3) {
                    stopPreview(card);
                }
            }, 3000);

            currentPreviewIndex = index;
        }

        function stopPreview(card) {
            // Remove spinning class from vinyl
            if (card) {
                const vinylContainer = card.querySelector('.vinyl-container-default');
                const vinylRecord = vinylContainer ? vinylContainer.querySelector('.vinyl-record') : null;
                if (vinylRecord) {
                    vinylRecord.classList.remove('spinning');
                }
            }

            // Clear any pending timeouts
            if (previewTimeout) {
                clearTimeout(previewTimeout);
                previewTimeout = null;
            }

            // Clear fade intervals
            if (fadeInInterval) {
                clearInterval(fadeInInterval);
                fadeInInterval = null;
            }

            if (previewAudio) {
                // Fade out quickly
                if (fadeOutInterval) {
                    clearInterval(fadeOutInterval);
                }
                
                fadeOutInterval = setInterval(() => {
                    if (previewAudio && previewAudio.volume > 0) {
                        previewAudio.volume = Math.max(previewAudio.volume - 0.2, 0);
                    } else {
                        if (fadeOutInterval) {
                            clearInterval(fadeOutInterval);
                            fadeOutInterval = null;
                        }
                        if (previewAudio) {
                            previewAudio.pause();
                            previewAudio.currentTime = 0;
                            previewAudio.volume = 0.4; // Reset for next play
                        }
                    }
                }, 30);
            }
            currentPreviewIndex = null;
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            stopPreview();
        });

        loadGallery();
    </script>
</body>
</html>
